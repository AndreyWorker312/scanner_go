<!DOCTYPE html>
<html>
<head>
  <title>Network Scanner - –ì–ª–∞–≤–Ω–∞—è</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
    }

    /* –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é */
    .sidebar {
      width: 250px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      padding: 20px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 1000;
    }

    .sidebar-header {
      padding: 0 20px 30px 20px;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 20px;
    }

    .sidebar-header h1 {
      color: #333;
      font-size: 24px;
      font-weight: 600;
      text-align: center;
    }

    .sidebar-header p {
      color: #666;
      font-size: 14px;
      text-align: center;
      margin-top: 5px;
    }

    .nav-menu {
      list-style: none;
    }

    .nav-item {
      margin: 5px 0;
    }

    .nav-link {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      color: #555;
      text-decoration: none;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
    }

    .nav-link:hover {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      border-left-color: #667eea;
    }

    .nav-link.active {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
      border-left-color: #667eea;
      font-weight: 600;
    }

    .nav-icon {
      width: 20px;
      height: 20px;
      margin-right: 12px;
      font-size: 18px;
    }

    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
    .main-content {
      flex: 1;
      margin-left: 250px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* –°–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü */
    .page {
      display: none;
      flex: 1;
      padding: 20px;
    }

    .page.active {
      display: flex;
      flex-direction: column;
    }

    /* –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ */
    .welcome-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 60px 40px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      max-width: 600px;
      margin: auto;
      width: 100%;
    }

    .welcome-card h2 {
      color: #333;
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .welcome-card p {
      color: #666;
      font-size: 18px;
      line-height: 1.6;
      margin-bottom: 30px;
    }

    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 40px;
    }

    .feature-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      padding: 30px 20px;
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
    }

    .feature-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    }

    .feature-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .feature-title {
      color: #333;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .feature-description {
      color: #666;
      font-size: 14px;
      line-height: 1.5;
    }

    /* –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è */
    .connection-status {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: 600;
      font-size: 14px;
      z-index: 1001;
    }

    .connection-status.connected {
      background: #28a745;
      color: white;
    }

    .connection-status.disconnected {
      background: #dc3545;
      color: white;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .welcome-card {
        padding: 40px 20px;
      }

      .welcome-card h2 {
        font-size: 28px;
      }

      .feature-grid {
        grid-template-columns: 1fr;
      }
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è ARP —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    .arp-page {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }

    .arp-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .arp-header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .arp-controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .button-group {
      margin: 10px 0;
    }

    button {
      margin: 5px;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .form-group {
      margin: 15px 0;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: bold;
    }

    .status.connected {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.disconnected {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .history-container {
      display: flex;
      gap: 20px;
    }

    .history-panel {
      flex: 1;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .history-header {
      background: #343a40;
      color: white;
      padding: 15px;
      font-weight: bold;
      font-size: 16px;
    }

    .history-header.online {
      background: #28a745;
    }

    .history-header.offline {
      background: #dc3545;
    }

    .history-content {
      padding: 15px;
      max-height: 500px;
      overflow-y: auto;
    }

    .scan-result {
      border: 1px solid #dee2e6;
      border-radius: 6px;
      margin-bottom: 15px;
      background: #f8f9fa;
    }

    .scan-header {
      background: #e9ecef;
      padding: 10px 15px;
      font-weight: bold;
      border-bottom: 1px solid #dee2e6;
    }

    .scan-body {
      padding: 15px;
    }

    .device-list {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 10px;
    }

    .device-item {
      padding: 5px 10px;
      margin: 2px 0;
      border-radius: 3px;
      font-family: monospace;
      font-size: 12px;
    }

    .device-online {
      background: #d4edda;
      color: #155724;
    }

    .device-offline {
      background: #f8d7da;
      color: #721c24;
    }

    .stats {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }

    .stat-item {
      background: #007bff;
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è ICMP —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    .icmp-page {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è Nmap —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    .nmap-page {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }
  </style>
</head>
<body>
  <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
  <div id="connectionStatus" class="connection-status disconnected">
    üî¥ –û—Ç–∫–ª—é—á–µ–Ω–æ
  </div>

  <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
  <nav class="sidebar">
    <div class="sidebar-header">
      <h1>üîç Network Scanner</h1>
      <p>–ú–Ω–æ–≥–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–∫–∞–Ω–µ—Ä —Å–µ—Ç–∏</p>
    </div>
    <ul class="nav-menu">
      <li class="nav-item">
        <a href="#" class="nav-link active" data-page="home">
          <span class="nav-icon">üè†</span>
          –ì–ª–∞–≤–Ω–∞—è
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-page="arp">
          <span class="nav-icon">üîç</span>
          ARP –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-page="icmp">
          <span class="nav-icon">üì°</span>
          ICMP Ping
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-page="nmap">
          <span class="nav-icon">‚ö°</span>
          Nmap –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        </a>
      </li>
    </ul>
  </nav>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <main class="main-content">
    <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
    <div id="home" class="page active">
      <div class="welcome-card">
        <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Network Scanner</h2>
        <p>–ú–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã. –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ç–∏–ø —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ –º–µ–Ω—é —Å–ª–µ–≤–∞.</p>
        
        <div class="feature-grid">
          <div class="feature-card" onclick="showPage('arp')">
            <div class="feature-icon">üîç</div>
            <div class="feature-title">ARP –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
            <div class="feature-description">–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏ –ø–æ MAC-–∞–¥—Ä–µ—Å–∞–º</div>
          </div>
          
          <div class="feature-card" onclick="showPage('icmp')">
            <div class="feature-icon">üì°</div>
            <div class="feature-title">ICMP Ping</div>
            <div class="feature-description">–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ö–æ—Å—Ç–æ–≤ —Å –ø–æ–º–æ—â—å—é ping</div>
          </div>
          
          <div class="feature-card" onclick="showPage('nmap')">
            <div class="feature-icon">‚ö°</div>
            <div class="feature-title">Nmap –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
            <div class="feature-description">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤ –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –û–°</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ARP —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
    <div id="arp" class="page arp-page">
      <div class="arp-container">
        <div class="arp-header">
          <h1>üåê Network Scanner - ARP Scanner</h1>
          <p>Real-time network device discovery and monitoring</p>
        </div>

        <div class="arp-controls">
          <div class="button-group">
            <button onclick="connect()" class="btn-success">Connect</button>
            <button onclick="disconnect()" id="disconnectBtn" class="btn-danger" disabled>Disconnect</button>
            <button onclick="clearHistory()" class="btn-secondary">Clear History</button>
          </div>

          <div id="status" class="status disconnected">Disconnected</div>

          <div style="display: flex; gap: 20px;">
            <div class="form-group" style="flex: 1;">
              <label for="interfaceSelect">Network Interface:</label>
              <select id="interfaceSelect">
                <option value="wlo1">wlo1 (WiFi)</option>
                <option value="eth0">eth0 (Ethernet)</option>
                <option value="enp0s3">enp0s3</option>
              </select>
            </div>
            
            <div class="form-group" style="flex: 1;">
              <label for="ipRangeInput">IP Range:</label>
              <input type="text" id="ipRangeInput" value="10.20.5.0/28" placeholder="e.g., 192.168.1.0/24">
            </div>
            
            <div class="form-group" style="flex: 0 0 auto; display: flex; align-items: end;">
              <button onclick="startScan()" id="scanBtn" class="btn-primary" disabled>Start Scan</button>
            </div>
          </div>
        </div>

        <div class="history-container">
          <div class="history-panel">
            <div class="history-header online">üü¢ Online Devices</div>
            <div class="history-content" id="onlineHistory">
              <p style="text-align: center; color: #666; margin-top: 50px;">No online devices found yet</p>
            </div>
          </div>
          
          <div class="history-panel">
            <div class="history-header offline">üî¥ Offline Devices</div>
            <div class="history-content" id="offlineHistory">
              <p style="text-align: center; color: #666; margin-top: 50px;">No offline devices found yet</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ICMP —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
    <div id="icmp" class="page icmp-page">
      <div class="arp-container">
        <div class="arp-header">
          <h1>üì° Network Scanner - ICMP Ping</h1>
          <p>Real-time host availability checking and network diagnostics</p>
        </div>

        <div class="arp-controls">
          <div class="button-group">
            <button onclick="connectIcmp()" class="btn-success">Connect</button>
            <button onclick="disconnectIcmp()" id="disconnectBtnIcmp" class="btn-danger" disabled>Disconnect</button>
            <button onclick="clearIcmpHistory()" class="btn-secondary">Clear History</button>
          </div>

          <div id="statusIcmp" class="status disconnected">Disconnected</div>

          <div style="display: flex; gap: 20px;">
            <div class="form-group" style="flex: 2;">
              <label for="targetsInput">Target Hosts (one per line):</label>
              <textarea id="targetsInput" rows="4" placeholder="8.8.8.8&#10;google.com&#10;192.168.1.1&#10;yandex.ru">8.8.8.8
google.com
192.168.1.1</textarea>
            </div>
            
            <div class="form-group" style="flex: 1;">
              <label for="pingCountSelect">Ping Count:</label>
              <select id="pingCountSelect">
                <option value="1">1 packet (quick)</option>
                <option value="4" selected>4 packets (standard)</option>
                <option value="10">10 packets (detailed)</option>
                <option value="20">20 packets (thorough)</option>
              </select>
            </div>
            
            <div class="form-group" style="flex: 0 0 auto; display: flex; align-items: end;">
              <button onclick="startIcmpScan()" id="scanBtnIcmp" class="btn-primary" disabled>Start Ping</button>
            </div>
          </div>

          <div class="button-group" style="margin-top: 15px;">
            <button onclick="addQuickTarget('8.8.8.8')" class="btn-secondary" style="padding: 5px 10px; font-size: 12px;">Google DNS</button>
            <button onclick="addQuickTarget('1.1.1.1')" class="btn-secondary" style="padding: 5px 10px; font-size: 12px;">Cloudflare</button>
            <button onclick="addQuickTarget('google.com')" class="btn-secondary" style="padding: 5px 10px; font-size: 12px;">Google</button>
            <button onclick="addQuickTarget('192.168.1.1')" class="btn-secondary" style="padding: 5px 10px; font-size: 12px;">Router</button>
            <button onclick="addQuickTarget('127.0.0.1')" class="btn-secondary" style="padding: 5px 10px; font-size: 12px;">Localhost</button>
          </div>
        </div>

        <div class="history-container">
          <div class="history-panel">
            <div class="history-header online">üü¢ Ping Results</div>
            <div class="history-content" id="icmpResults">
              <p style="text-align: center; color: #666; margin-top: 50px;">No ping results yet</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Nmap —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
    <div id="nmap" class="page nmap-page">
      <div style="padding: 20px; text-align: center;">
        <h1>‚ö° Nmap –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
        <p>Nmap —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–¥–µ—Å—å</p>
      </div>
    </div>
  </main>

  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è ARP —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
    let socket = null;
    let socketIcmp = null;
    let scanHistory = [];
    let icmpHistory = [];

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏
    function showPage(pageId) {
      // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      
      // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
      document.getElementById(pageId).classList.add('active');
      
      // –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –º–µ–Ω—é
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });
      document.querySelector(`[data-page="${pageId}"]`).classList.add('active');

      // –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ WebSocket –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      if (pageId === 'arp' && !socket) {
        setTimeout(connect, 500);
      }
      if (pageId === 'icmp' && !socketIcmp) {
        setTimeout(connectIcmp, 500);
      }
      
      // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
      updateGlobalConnectionStatus();
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –ø–æ –º–µ–Ω—é
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const pageId = link.getAttribute('data-page');
        showPage(pageId);
      });
    });

    // ARP —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
    const statusElement = document.getElementById('status');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const scanBtn = document.getElementById('scanBtn');
    const interfaceSelect = document.getElementById('interfaceSelect');
    const ipRangeInput = document.getElementById('ipRangeInput');
    const onlineHistory = document.getElementById('onlineHistory');
    const offlineHistory = document.getElementById('offlineHistory');

    function updateStatus(connected) {
      if (connected) {
        statusElement.textContent = '‚úÖ Connected to WebSocket';
        statusElement.className = 'status connected';
        disconnectBtn.disabled = false;
        scanBtn.disabled = false;
      } else {
        statusElement.textContent = '‚ùå Disconnected';
        statusElement.className = 'status disconnected';
        disconnectBtn.disabled = true;
        scanBtn.disabled = true;
      }
      updateGlobalConnectionStatus();
    }

    function addScanToHistory(scanData) {
      console.log('addScanToHistory called with:', scanData);
      const timestamp = new Date().toLocaleTimeString();
      const scanId = Date.now();
      
      const scanResult = {
        id: scanId,
        timestamp: timestamp,
        interface: scanData.interface_name || interfaceSelect.value,
        ipRange: scanData.ip_range || ipRangeInput.value,
        totalCount: scanData.TotalCount || scanData.total_count || 0,
        onlineCount: scanData.OnlineCount || scanData.online_count || 0,
        offlineCount: scanData.OfflineCount || scanData.offline_count || 0,
        onlineDevices: scanData.OnlineDevices || scanData.online_devices || [],
        offlineDevices: scanData.OfflineDevices || scanData.offline_devices || []
      };
      
      scanHistory.unshift(scanResult);
      if (scanHistory.length > 10) scanHistory.pop();
      
      updateHistoryDisplay();
    }

    function updateHistoryDisplay() {
      onlineHistory.innerHTML = '';
      offlineHistory.innerHTML = '';
      
      if (scanHistory.length === 0) {
        onlineHistory.innerHTML = '<p style="text-align: center; color: #666; margin-top: 50px;">No scans performed yet</p>';
        offlineHistory.innerHTML = '<p style="text-align: center; color: #666; margin-top: 50px;">No scans performed yet</p>';
        return;
      }
      
      scanHistory.forEach((scan, index) => {
        if (scan.onlineCount > 0) {
          const onlinePanel = createScanPanel(scan, 'online');
          onlineHistory.appendChild(onlinePanel);
        }
        
        if (scan.offlineCount > 0) {
          const offlinePanel = createScanPanel(scan, 'offline');
          offlineHistory.appendChild(offlinePanel);
        }
      });
      
      if (onlineHistory.children.length === 0) {
        onlineHistory.innerHTML = '<p style="text-align: center; color: #666; margin-top: 50px;">No online devices found</p>';
      }
      if (offlineHistory.children.length === 0) {
        offlineHistory.innerHTML = '<p style="text-align: center; color: #666; margin-top: 50px;">No offline devices found</p>';
      }
    }

    function createScanPanel(scan, type) {
      const panel = document.createElement('div');
      panel.className = 'scan-result';
      
      const header = document.createElement('div');
      header.className = 'scan-header';
      header.innerHTML = `
        <div>üì° ${scan.timestamp} - ${scan.interface}</div>
        <div style="font-size: 12px; font-weight: normal; margin-top: 2px;">${scan.ipRange}</div>
      `;
      
      const body = document.createElement('div');
      body.className = 'scan-body';
      
      const stats = document.createElement('div');
      stats.className = 'stats';
      stats.innerHTML = `
        <div class="stat-item">Total: ${scan.totalCount}</div>
        <div class="stat-item" style="background: #28a745;">Online: ${scan.onlineCount}</div>
        <div class="stat-item" style="background: #dc3545;">Offline: ${scan.offlineCount}</div>
      `;
      
      const deviceList = document.createElement('div');
      deviceList.className = 'device-list';
      
      const devices = type === 'online' ? scan.onlineDevices : scan.offlineDevices;
      devices.forEach(device => {
        const deviceItem = document.createElement('div');
        deviceItem.className = `device-item device-${device.status}`;
        deviceItem.innerHTML = `
          <div><strong>${device.ip}</strong></div>
          <div>MAC: ${device.mac || 'Unknown'}</div>
          <div>Status: ${device.status}</div>
        `;
        deviceList.appendChild(deviceItem);
      });
      
      body.appendChild(stats);
      body.appendChild(deviceList);
      
      panel.appendChild(header);
      panel.appendChild(body);
      
      return panel;
    }

    function connect() {
      if (socket && socket.readyState === WebSocket.OPEN) {
        return;
      }

      try {
        socket = new WebSocket('ws://localhost:8080/ws');

        socket.onopen = function(event) {
          updateStatus(true);
        };

        socket.onmessage = function(event) {
          try {
            const parsed = JSON.parse(event.data);
            
            if (parsed.type === 'response' && parsed.response && parsed.response.result) {
              addScanToHistory(parsed.response.result);
            }
          } catch (e) {
            console.error('Error parsing response:', e);
          }
        };

        socket.onerror = function(error) {
          console.error('WebSocket error:', error);
        };

        socket.onclose = function(event) {
          updateStatus(false);
        };

      } catch (error) {
        console.error('Connection failed:', error);
      }
    }

    function disconnect() {
      if (socket) {
        socket.close(1000, 'User disconnected');
        socket = null;
      }
    }

    function startScan() {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        alert('‚ùå Not connected to WebSocket');
        return;
      }

      const interfaceName = interfaceSelect.value;
      const ipRange = ipRangeInput.value.trim();

      if (!ipRange) {
        alert('‚ùå IP range is required');
        return;
      }

      const request = {
        type: "request",
        request: {
          scanner_service: "arp_service",
          options: {
            interface_name: interfaceName,
            ip_range: ipRange
          }
        }
      };

      try {
        socket.send(JSON.stringify(request));
        scanBtn.textContent = 'Scanning...';
        scanBtn.disabled = true;
        
        setTimeout(() => {
          scanBtn.textContent = 'Start Scan';
          scanBtn.disabled = false;
        }, 10000);
        
      } catch (error) {
        alert('‚ùå Failed to send scan request: ' + error.message);
      }
    }

    function clearHistory() {
      scanHistory = [];
      updateHistoryDisplay();
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    function updateGlobalConnectionStatus() {
      const globalStatus = document.getElementById('connectionStatus');
      const isConnected = (socket && socket.readyState === WebSocket.OPEN) || 
                         (socketIcmp && socketIcmp.readyState === WebSocket.OPEN);
      
      if (isConnected) {
        globalStatus.textContent = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
        globalStatus.className = 'connection-status connected';
      } else {
        globalStatus.textContent = 'üî¥ –û—Ç–∫–ª—é—á–µ–Ω–æ';
        globalStatus.className = 'connection-status disconnected';
      }
    }

    // ICMP —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
    const statusElementIcmp = document.getElementById('statusIcmp');
    const disconnectBtnIcmp = document.getElementById('disconnectBtnIcmp');
    const scanBtnIcmp = document.getElementById('scanBtnIcmp');
    const targetsInput = document.getElementById('targetsInput');
    const pingCountSelect = document.getElementById('pingCountSelect');
    const icmpResults = document.getElementById('icmpResults');

    function updateIcmpStatus(connected) {
      if (connected) {
        statusElementIcmp.textContent = '‚úÖ Connected to WebSocket';
        statusElementIcmp.className = 'status connected';
        disconnectBtnIcmp.disabled = false;
        scanBtnIcmp.disabled = false;
      } else {
        statusElementIcmp.textContent = '‚ùå Disconnected';
        statusElementIcmp.className = 'status disconnected';
        disconnectBtnIcmp.disabled = true;
        scanBtnIcmp.disabled = true;
      }
      updateGlobalConnectionStatus();
    }

    function connectIcmp() {
      if (socketIcmp && socketIcmp.readyState === WebSocket.OPEN) {
        return;
      }

      try {
        socketIcmp = new WebSocket('ws://localhost:8080/ws');

        socketIcmp.onopen = function(event) {
          updateIcmpStatus(true);
        };

        socketIcmp.onmessage = function(event) {
          try {
            console.log('ICMP WebSocket message received:', event.data);
            const parsed = JSON.parse(event.data);
            console.log('ICMP parsed message:', parsed);
            
            if (parsed.type === 'response' && parsed.response && parsed.response.result) {
              console.log('ICMP calling addIcmpToHistory with:', parsed.response.result);
              addIcmpToHistory(parsed.response.result);
            } else {
              console.log('ICMP message does not match expected format');
            }
          } catch (e) {
            console.error('Error parsing ICMP response:', e);
          }
        };

        socketIcmp.onerror = function(error) {
          console.error('ICMP WebSocket error:', error);
        };

        socketIcmp.onclose = function(event) {
          updateIcmpStatus(false);
        };

      } catch (error) {
        console.error('ICMP connection failed:', error);
      }
    }

    function disconnectIcmp() {
      if (socketIcmp) {
        socketIcmp.close(1000, 'User disconnected');
        socketIcmp = null;
      }
    }

    function startIcmpScan() {
      if (!socketIcmp || socketIcmp.readyState !== WebSocket.OPEN) {
        alert('‚ùå Not connected to WebSocket');
        return;
      }

      const targetsText = targetsInput.value.trim();
      const pingCount = parseInt(pingCountSelect.value);

      if (!targetsText) {
        alert('‚ùå Targets are required');
        return;
      }

      const targets = targetsText
        .split('\n')
        .map(target => target.trim())
        .filter(target => target.length > 0);

      if (targets.length === 0) {
        alert('‚ùå Please enter at least one target');
        return;
      }

      const request = {
        type: "request",
        request: {
          scanner_service: "icmp_service",
          options: {
            targets: targets,
            ping_count: pingCount
          }
        }
      };

      try {
        socketIcmp.send(JSON.stringify(request));
        scanBtnIcmp.textContent = 'Pinging...';
        scanBtnIcmp.disabled = true;
        
        setTimeout(() => {
          scanBtnIcmp.textContent = 'Start Ping';
          scanBtnIcmp.disabled = false;
        }, 15000);
        
      } catch (error) {
        alert('‚ùå Failed to send ping request: ' + error.message);
      }
    }

    function addQuickTarget(target) {
      const currentValue = targetsInput.value.trim();
      if (currentValue) {
        targetsInput.value = currentValue + '\n' + target;
      } else {
        targetsInput.value = target;
      }
    }

    function addIcmpToHistory(result) {
      console.log('addIcmpToHistory called with:', result);
      console.log('result.results:', result.results);
      const timestamp = new Date().toLocaleTimeString();
      const scanId = Date.now();
      
      const pingResult = {
        id: scanId,
        timestamp: timestamp,
        results: result.results || [],
        totalTargets: result.results ? result.results.length : 0
      };
      
      console.log('Created pingResult:', pingResult);
      
      icmpHistory.unshift(pingResult);
      if (icmpHistory.length > 10) icmpHistory.pop();
      
      console.log('ICMP history length:', icmpHistory.length);
      updateIcmpHistoryDisplay();
    }

    function updateIcmpHistoryDisplay() {
      icmpResults.innerHTML = '';
      
      if (icmpHistory.length === 0) {
        icmpResults.innerHTML = '<p style="text-align: center; color: #666; margin-top: 50px;">No ping results yet</p>';
        return;
      }
      
      icmpHistory.forEach((ping, index) => {
        const pingPanel = createIcmpResultPanel(ping);
        icmpResults.appendChild(pingPanel);
      });
    }

    function createIcmpResultPanel(ping) {
      const panel = document.createElement('div');
      panel.className = 'scan-result';
      
      const header = document.createElement('div');
      header.className = 'scan-header';
      header.innerHTML = `
        <div>üì° ${ping.timestamp} - ${ping.totalTargets} targets</div>
      `;
      
      const body = document.createElement('div');
      body.className = 'scan-body';
      
      const deviceList = document.createElement('div');
      deviceList.className = 'device-list';
      
      ping.results.forEach(result => {
        const deviceItem = document.createElement('div');
        const isSuccess = result.packets_received > 0;
        deviceItem.className = `device-item ${isSuccess ? 'device-online' : 'device-offline'}`;
        
        const packetLoss = result.packet_loss_percent || 0;
        deviceItem.innerHTML = `
          <div><strong>${result.target}</strong> (${result.address})</div>
          <div>Packets: ${result.packets_received || 0}/${result.packets_sent || 0}</div>
          <div>Loss: ${packetLoss.toFixed(1)}%</div>
          ${result.error ? `<div style="color: #dc3545;">Error: ${result.error}</div>` : ''}
        `;
        deviceList.appendChild(deviceItem);
      });
      
      body.appendChild(deviceList);
      
      panel.appendChild(header);
      panel.appendChild(body);
      
      return panel;
    }

    function clearIcmpHistory() {
      icmpHistory = [];
      updateIcmpHistoryDisplay();
    }

    // Hotkeys
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'Enter') {
        const activePage = document.querySelector('.page.active').id;
        if (activePage === 'arp') {
          startScan();
        } else if (activePage === 'icmp') {
          startIcmpScan();
        }
      }
    });
  </script>
</body>
</html>